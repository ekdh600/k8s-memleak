name: Memory Leak Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  memory-leak-test:
    runs-on: ubuntu-latest
    name: λ©”λ¨λ¦¬ λ„μ ν…μ¤νΈ
    
    steps:
      - name: π“¥ μ½”λ“ μ²΄ν¬μ•„μ›ƒ
        uses: actions/checkout@v4
        
      - name: πΉ Go ν™κ²½ μ„¤μ •
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          
      - name: π“¦ μμ΅΄μ„± λ‹¤μ΄λ΅λ“
        run: go mod download
        
      - name: π”¨ μ• ν”λ¦¬μΌ€μ΄μ… λΉλ“
        run: go build -o app main.go
        
      - name: π§ λ‹¨μ„ ν…μ¤νΈ (pprof κΈ°λ°)
        run: go test -v -run TestHeapDoesNotGrowUnbounded -timeout 2m
        
      - name: π§ λ©”λ¨λ¦¬ λ„μ μ‹λ®¬λ μ΄μ… ν…μ¤νΈ
        run: go test -v -run TestMemoryLeakSimulation -timeout 1m
        
      - name: π” ν”„λ΅μ„Έμ¤ λ©”λ¨λ¦¬ λ„μ κ²€μ‚¬ (RSS μ¦κ°€λ‰)
        run: |
          chmod +x ci/leak_check.sh
          BIN=./app DURATION=30 THRESHOLD_KB=15000 ./ci/leak_check.sh
          
      - name: π“ pprof ν™ ν”„λ΅νμΌ μƒμ„±
        run: |
          # μ• ν”λ¦¬μΌ€μ΄μ… λ°±κ·ΈλΌμ΄λ“ μ‹¤ν–‰
          ./app >/dev/null 2>&1 &
          PID=$!
          sleep 5
          
          # ν™ ν”„λ΅νμΌ μμ§‘
          curl -s http://localhost:6060/debug/pprof/heap > heap_profile.pb
          
          # ν”„λ΅νμΌ μ •λ³΄ μ¶λ ¥
          echo "ν™ ν”„λ΅νμΌ ν¬κΈ°: $(wc -c < heap_profile.pb) bytes"
          
          # ν”„λ΅μ„Έμ¤ μΆ…λ£
          kill $PID || true
          
      - name: π― ν…μ¤νΈ κ²°κ³Ό μ”μ•½
        run: |
          echo "β… λ¨λ“  λ©”λ¨λ¦¬ λ„μ ν…μ¤νΈ μ™„λ£"
          echo "π“ ν…μ¤νΈ κ²°κ³Ό:"
          echo "   - Go λ‹¨μ„ ν…μ¤νΈ: ν†µκ³Ό"
          echo "   - λ©”λ¨λ¦¬ λ„μ μ‹λ®¬λ μ΄μ…: ν†µκ³Ό"
          echo "   - RSS μ¦κ°€λ‰ κ²€μ‚¬: μ™„λ£"
          echo "   - pprof ν™ ν”„λ΅νμΌ: μƒμ„±λ¨"

  kubernetes-leak-demo:
    runs-on: ubuntu-latest
    name: μΏ λ²„λ„¤ν‹°μ¤ λ©”λ¨λ¦¬ λ„μ λ°λ¨
    needs: memory-leak-test
    
    steps:
      - name: π“¥ μ½”λ“ μ²΄ν¬μ•„μ›ƒ
        uses: actions/checkout@v4
        
      - name: π³ Docker λΉλ“
        run: |
          docker build -t memleak:ci .
          
      - name: π€ Kind ν΄λ¬μ¤ν„° μ„¤μ •
        uses: helm/kind-action@v1.10.0
        with:
          node_image: kindest/node:v1.28.0
          
      - name: π“¦ μ΄λ―Έμ§€ λ΅λ“
        run: |
          kind load docker-image memleak:ci
          
      - name: π― λ©”λ¨λ¦¬ λ„μ λ°λ¨ λ°°ν¬
        run: |
          cat > leaky.yaml <<'YAML'
          apiVersion: v1
          kind: Namespace
          metadata:
            name: memleak-demo
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: leaky
            namespace: memleak-demo
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: leaky
            template:
              metadata:
                labels:
                  app: leaky
              spec:
                containers:
                - name: leaky
                  image: memleak:ci
                  ports:
                  - containerPort: 6060
                  resources:
                    requests:
                      memory: "128Mi"
                      cpu: "100m"
                    limits:
                      memory: "512Mi"
                      cpu: "500m"
          YAML
          
          kubectl apply -f leaky.yaml
          kubectl -n memleak-demo rollout status deploy/leaky --timeout=120s
          
      - name: π” Pod μƒνƒ ν™•μΈ
        run: |
          kubectl -n memleak-demo get pods
          kubectl -n memleak-demo describe pod -l app=leaky
          
      - name: π“ pprof ν™ ν”„λ΅νμΌ μμ§‘ (ν¬νΈν¬μ›λ”©)
        run: |
          POD=$(kubectl -n memleak-demo get pod -l app=leaky -o jsonpath='{.items[0].metadata.name}')
          
          # ν¬νΈν¬μ›λ”© μ‹μ‘
          kubectl -n memleak-demo port-forward pod/$POD 6060:6060 >/dev/null 2>&1 &
          PF_PID=$!
          
          # ν¬νΈν¬μ›λ”© λ€κΈ°
          sleep 5
          
          # ν™ ν”„λ΅νμΌ μμ§‘
          curl -s http://127.0.0.1:6060/debug/pprof/heap > k8s_heap.pb
          
          # ν”„λ΅νμΌ λ¶„μ„
          echo "μΏ λ²„λ„¤ν‹°μ¤ ν™ ν”„λ΅νμΌ ν¬κΈ°: $(wc -c < k8s_heap.pb) bytes"
          
          # ν¬νΈν¬μ›λ”© μΆ…λ£
          kill $PF_PID || true
          
      - name: π§Ή μ •λ¦¬
        run: |
          kubectl delete ns memleak-demo --ignore-not-found=true
          echo "β… μΏ λ²„λ„¤ν‹°μ¤ λ°λ¨ μ •λ¦¬ μ™„λ£"